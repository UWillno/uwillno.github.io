<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="icon" type="image/png" href="uwlogo.png" />
  <title>UWillno's Blog</title>
  <style>
    :root {
      --primary-bg: #ffffff;
      --primary-text: #222222;
      --secondary-text: #555555;
      --accent-color: #088572;
      --border-color: #e0e0e0;
      --card-bg: #f8f9fa;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --loading-color: #23D1AES;
      --error-color: #ea4335;
      --success-color: #34a853;
    }

    /* 默认链接颜色 */
    a {
      color: #088572;
      text-decoration: none;
      /* 去掉默认下划线 */
      transition: color 0.2s ease, text-decoration-color 0.2s ease;
    }

    /* 访问过的链接 */
    a:visited {
      color: #066a5a;
      /* 稍微深一点，区分已访问 */
    }

    /* 鼠标悬停时 */
    a:hover {
      color: #0aa684;
      /* 亮一点，显得有反馈 */
      text-decoration: underline;
      text-decoration-color: #0aa684;
    }

    /* 点击时（激活状态） */
    a:active {
      color: #044d41;
      /* 更深，表示点击 */
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --primary-bg: #121212;
        --primary-text: #f0f0f0;
        --secondary-text: #aaaaaa;
        --accent-color: #088572;
        --border-color: #333333;
        --card-bg: #1e1e1e;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        --loading-color: #23D1AE;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: var(--primary-bg);
      color: var(--primary-text);
    }

    #loading-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      background-color: var(--primary-bg);
      padding: 20px;
    }

    .logo {
      width: 180px;
      height: 180px;
      margin-bottom: 1.5rem;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--primary-text);
    }

    .subtitle {
      font-size: 1rem;
      color: var(--secondary-text);
      margin-bottom: 2rem;
      max-width: 80%;
      text-align: center;
    }

    .loading-card {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      margin-bottom: 2rem;
    }

    @media (orientation: portrait) {
      .loading-card {
        margin-left: 16px;
        margin-right: 16px;
        width: calc(100% - 32px);
      }
    }

    .progress-container {
      width: 100%;
      height: 6px;
      background-color: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
      overflow: hidden;
      margin: 1rem 0;
    }

    @media (prefers-color-scheme: dark) {
      .progress-container {
        background-color: rgba(255, 255, 255, 0.1);
      }
    }

    .progress-bar {
      height: 100%;
      width: 0;
      background-color: var(--loading-color);
      transition: width 0.3s ease;
    }

    .status {
      font-size: 1rem;
      font-weight: 500;
      margin: 0.5rem 0;
      color: var(--primary-text);
      display: flex;
      align-items: center;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--loading-color);
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
      flex-shrink: 0;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .status-text {
      flex-grow: 1;
    }

    .network-tip {
      font-size: 0.9rem;
      color: var(--secondary-text);
      margin-top: 1rem;
      line-height: 1.5;
      text-align: center;
    }

    #loading-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 0.85rem;
      color: var(--secondary-text);
      padding: 1rem;
      z-index: 1001;
    }

    #loading-footer a {
      color: var(--accent-color);
      text-decoration: none;
      transition: opacity 0.2s ease;
    }

    #loading-footer a:hover {
      opacity: 0.8;
      text-decoration: underline;
    }

    #qt-container {
      width: 100%;
      height: 100%;
      display: none;
    }

    .error-message {
      color: var(--error-color);
      font-weight: 500;
      margin-top: 1rem;
    }

    .success-message {
      color: var(--success-color);
      font-weight: 500;
      margin-top: 1rem;
    }

    @media (max-width: 600px) {
      .logo {
        width: 140px;
        height: 140px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .subtitle {
        font-size: 0.9rem;
      }

      .loading-card {
        padding: 1rem;
      }
    }
  </style>
</head>

<body>
  <!-- 加载界面 -->
  <div id="loading-container">
    <img src="uwlogo.png" alt="UWillno Logo" class="logo" />
    <h1>UWillno's Blog</h1>
    <p class="subtitle">Qt for WebAssembly</p>

    <div class="loading-card">
      <div class="status" id="qtstatus">
        <span class="spinner"></span>
        <span class="status-text">Initializing application...</span>
      </div>
      <div class="progress-container">
        <div class="progress-bar" id="progress"></div>
      </div>
      <p class="network-tip">
        使用多线程，浏览器需支持<a
          href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer"
          target="_blank">SharedArrayBuffer</a>。<br />
        Uses multi-threading, browser must support <a
          href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer"
          target="_blank">SharedArrayBuffer</a>.
      </p>


    </div>
  </div>

  <!-- 页脚（仅加载时显示） -->
  <div id="loading-footer">
    <a href="https://icp.gov.moe/?keyword=20249102" target="_blank">萌ICP备20249102号</a>
  </div>
  <script src="coi-serviceworker.min.js"></script>
  <!-- WASM 容器（全屏） -->
  <div id="qt-container"></div>
  <script type="text/javascript">
    const wasmParts = [
      "blog01.wasm",
      "blog02.wasm",
      "blog03.wasm",
      "blog04.wasm",
      "blog05.wasm",
      "blog06.wasm",
      "blog07.wasm",
      "blog08.wasm",
      "blog09.wasm",
      "blog10.wasm",
    ];

    // 带重试 + 指数退避的 fetch
    async function fetchWithRetry(
      url,
      retries = 3,
      delay = 1000,
      maxDelay = 10000
    ) {
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.arrayBuffer();
        } catch (err) {
          console.warn(`请求失败 [${url}] 第 ${attempt} 次:`, err);
          if (attempt < retries) {
            const waitTime = Math.min(delay * Math.pow(2, attempt - 1), maxDelay);
            console.log(`等待 ${waitTime} ms 后重试`);
            await new Promise((r) => setTimeout(r, waitTime));
          } else {
            throw err;
          }
        }
      }
    }

    // 生成临时 URL 理论上可以直接读buffer，但是我不确定qt后续是否需要用到
    async function loadAndMergeWasm(parts) {
      // const buffers = await Promise.all(
      //   parts.map((url) => fetch(url).then((res) => res.arrayBuffer()))
      // );
      const buffers = await Promise.all(
        parts.map((url) => fetchWithRetry(url, 5, 1000, 5000))
      );
      const totalLength = buffers.reduce((sum, b) => sum + b.byteLength, 0);
      const merged = new Uint8Array(totalLength);
      let offset = 0;
      for (const buf of buffers) {
        merged.set(new Uint8Array(buf), offset);
        offset += buf.byteLength;
      }
      const blob = new Blob([merged], { type: "application/wasm" });
      const tempUrl = URL.createObjectURL(blob);
      return tempUrl;
    }


    var finishedCount = 0;
    var totalCount = wasmParts.length;
    var instance = null;
    var progressInterval = null;
    var currentProgress = 0;
    var maxAutoProgress = 0;

    async function init() {
      const statusText = document.querySelector("#qtstatus .status-text");
      const spinner = document.querySelector("#qtstatus .spinner");
      const progress = document.getElementById("progress");
      const loadingContainer = document.getElementById("loading-container");
      const loadingFooter = document.getElementById("loading-footer");

      try {
        // 启动自动进度条
        startAutoProgress();

        // 加载Qt应用
        instance = await qtLoad({
          qt: {
            onLoaded: () => {
              // 完成加载，进度到100%
              stopAutoProgress();
              updateProgress(100, "Finalizing...");

              // 隐藏spinner并显示完成状态
              spinner.style.display = "none";
              statusText.innerHTML = '<span class="success-message">✓ Application ready</span>';

              // 延迟隐藏加载界面以确保过渡平滑
              setTimeout(() => {
                loadingContainer.style.display = "none";
                loadingFooter.style.display = "none";
                document.getElementById("qt-container").style.display = "block";

                // 确保布局正确
                setTimeout(() => window.dispatchEvent(new Event('resize')), 50);
              }, 500);
            },
            onExit: (exitData) => {
              stopAutoProgress();
              let message = "Application exited";
              message += exitData.code !== undefined ? ` with code ${exitData.code}` : "";
              message += exitData.text !== undefined ? ` (${exitData.text})` : "";

              // 隐藏spinner并显示错误状态
              spinner.style.display = "none";
              statusText.innerHTML = `<span class="error-message">✗ ${message}</span>`;
              progress.style.backgroundColor = "var(--error-color)";

              // 显示加载界面以便用户看到错误信息
              loadingContainer.style.display = "flex";
              loadingFooter.style.display = "block";
              document.getElementById("qt-container").style.display = "none";
            },
            entryFunction: window.blog_entry,
            containerElements: [document.getElementById("qt-container")],
          },
        });
      } catch (e) {
        console.error(e);
        stopAutoProgress();

        // 隐藏spinner并显示错误状态
        spinner.style.display = "none";
        statusText.innerHTML = `<span class="error-message">✗ Failed to load: ${e.message}</span>`;
        progress.style.backgroundColor = "var(--error-color)";
      }
    }

    // 自动进度条功能
    function startAutoProgress() {
      currentProgress = 0;
      updateProgress(0, "Starting application...");

      // 每300ms增加1-3%的进度，直到达到maxAutoProgress
      progressInterval = setInterval(() => {
        currentProgress = 100 / totalCount * finishedCount;
        // maxAutoProgress = 100 / totalCount * (finishedCount +1 ) > 100 ? 100 :  100 / totalCount * (finishedCount +1 );
        // if (currentProgress <= maxAutoProgress) {
        //   const increment = 1 + Math.random() * 2; // 随机增量
        //   currentProgress = Math.min(currentProgress + increment, maxAutoProgress);
        updateProgress(currentProgress, "Loading application...");
        // }
      }, 100);
    }

    function stopAutoProgress() {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
    }

    function updateProgress(percent, message) {
      percent = Math.min(Math.max(percent, 0), 100);
      document.getElementById("progress").style.width = `${percent}%`;
      if (message) {
        document.querySelector("#qtstatus .status-text").textContent = message;
      }
    }

    // 启动初始化
    window.addEventListener("DOMContentLoaded", init);

    // var uncaughtCount = 0;

    (function () {
      let uncaughtCount = 0;
      let errorWindowMs = 5000; // 统计周期：5秒
      let lastReset = Date.now();

      window.addEventListener("error", function (event) {
        const msg = event.message || "";

        // 致命错误：立即刷新 其实根本刷新不了
        // if (msg.includes("Aborted(native code called abort())")) {
        //   console.error("检测到 abort()，立即刷新页面");
        //   location.reload();
        //   return;
        // }

        // 非致命错误计数
        if (msg.includes("Uncaught")) {
          console.warn("捕获到未处理异常：", msg);

          const now = Date.now();
          // 周期性重置计数
          if (now - lastReset > errorWindowMs) {
            uncaughtCount = 0;
            lastReset = now;
          }

          if (++uncaughtCount > 10) {
            console.error("短时间内错误过多，刷新页面以恢复");
            location.reload();
          }
        }
      });

      // === 兜底：捕获未处理的 Promise 错误 ===
      window.addEventListener("unhandledrejection", function (event) {
        console.warn("未处理的 Promise 异常：", event.reason);
      });
    })();




  </script>
  <script src="blog.min.js"></script>
  <script type="text/javascript" src="qtloader.js"></script>
</body>

</html>